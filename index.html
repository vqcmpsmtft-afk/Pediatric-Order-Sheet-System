<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pediatric Emergency Order Sheet</title>
  <style>
    body {
      font-family: "Segoe UI", "Inter", Helvetica, Arial, sans-serif;
      background: #f9fcfe;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #4fc3f7;
      color: white;
      text-align: center;
      padding: 15px 0;
      font-size: 1.5em;
      font-weight: bold;
      letter-spacing: 0.5px;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      border: 1px solid #cfe9f9;
      border-radius: 8px;
      padding: 20px 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    label {
      font-weight: 600;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0 15px;
      border-radius: 4px;
      border: 1px solid #cfe9f9;
      width: 100%;
      font-size: 1em;
    }
    button {
      background-color: #4fc3f7;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background-color: #29b6f6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border: 1px solid #cfe9f9;
    }
    th, td {
      border: 1px solid #cfe9f9;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e1f5fe;
    }
    .pdf-footer {
      margin-top: 40px;
      font-size: 0.9em;
      text-align: center;
      color: #777;
    }
    .top-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <header>Pediatric Emergency Order Sheet</header>
  <div class="container">
    <div class="top-buttons">
      <button id="generatePdf">Generate PDF</button>
    </div>

    <label for="weight">Patient Weight (kg)</label>
    <input type="number" id="weight" placeholder="Enter weight" step="0.1" />

    <label for="drug">Drug</label>
    <select id="drug"></select>

    <label for="route">Route</label>
    <select id="route"></select>

    <button id="calculate">Add to Order Sheet</button>

    <table id="orderTable">
      <thead>
        <tr>
          <th>Drug</th>
          <th>Route</th>
          <th>Dose</th>
          <th>Indication / Comment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pdf-footer">
      <p>Doctor’s Name: ______________________ &nbsp;&nbsp; Signature: ______________________</p>
      <p>Generated by Pediatric Order Sheet System v1.0</p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let drugData = [];
    const drugSelect = document.getElementById("drug");
    const routeSelect = document.getElementById("route");
    const orderTable = document.getElementById("orderTable").querySelector("tbody");

    async function loadExcel() {
      const response = await fetch("pediatric_med_library.xlsx");
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      drugData = json;
      populateDrugs();
    }

    function populateDrugs() {
      const drugs = [...new Set(drugData.map(d => d.DrugName))];
      drugs.forEach(drug => {
        const opt = document.createElement("option");
        opt.value = drug;
        opt.textContent = drug;
        drugSelect.appendChild(opt);
      });
      updateRoutes();
    }

    function updateRoutes() {
      routeSelect.innerHTML = "";
      const selectedDrug = drugSelect.value;
      const routes = [...new Set(drugData.filter(d => d.DrugName === selectedDrug).map(d => d.Route))];
      routes.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        routeSelect.appendChild(opt);
      });
    }

    drugSelect.addEventListener("change", updateRoutes);

    document.getElementById("calculate").addEventListener("click", () => {
      const weight = parseFloat(document.getElementById("weight").value);
      const drug = drugSelect.value;
      const route = routeSelect.value;
      const entry = drugData.find(d => d.DrugName === drug && d.Route === route);
      if (!entry || isNaN(weight)) return alert("Enter weight and select valid drug/route.");

      let doseMg = entry.DoseMgPerKg ? weight * parseFloat(entry.DoseMgPerKg) : null;
      if (doseMg && entry.MaxDoseMg && doseMg > entry.MaxDoseMg) doseMg = parseFloat(entry.MaxDoseMg);
      let doseMl = entry.DoseMlPerKg ? weight * parseFloat(entry.DoseMlPerKg) : null;
      if (!doseMg && entry.ConcMgPerMl && doseMl) doseMg = doseMl * parseFloat(entry.ConcMgPerMl);

      let doseText = "";
      if (doseMg && doseMl) doseText = `${doseMg.toFixed(1)} mg (${doseMl.toFixed(2)} mL)`;
      else if (doseMg) doseText = `${doseMg.toFixed(1)} mg`;
      else if (doseMl) doseText = `${doseMl.toFixed(2)} mL`;

      const row = orderTable.insertRow();
      row.insertCell().textContent = drug;
      row.insertCell().textContent = route;
      row.insertCell().textContent = doseText;
      row.insertCell().textContent = entry.Indication + (entry.Comment ? " – " + entry.Comment : "");
    });

    document.getElementById("generatePdf").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const date = new Date().toLocaleString();

      // Header
      doc.setFontSize(14);
      doc.text("Pediatric Emergency Order Sheet", 105, 15, { align: "center" });
      doc.setFontSize(10);
      doc.text(`Generated on ${date}`, 105, 22, { align: "center" });
      doc.rect(10, 10, 190, 277); // thin border

      // Table headers
      doc.setFontSize(11);
      let y = 35;
      doc.text("Drug", 15, y);
      doc.text("Route", 65, y);
      doc.text("Dose", 100, y);
      doc.text("Indication / Comment", 135, y);
      y += 6;

      // Table content
      Array.from(orderTable.rows).forEach(row => {
        const [drug, route, dose, comment] = Array.from(row.cells).map(td => td.textContent);
        doc.text(drug, 15, y);
        doc.text(route, 65, y);
        doc.text(dose, 100, y);
        doc.text(doc.splitTextToSize(comment, 60), 135, y);
        y += 6;
        if (y > 270) { doc.addPage(); y = 20; }
      });

      // Footer
      y += 10;
      doc.setFontSize(10);
      doc.text("Doctor’s Name: ______________________    Signature: ______________________", 15, y);
      y += 6;
      doc.text("Generated by Pediatric Order Sheet System v1.0", 105, y, { align: "center" });

      doc.save("Pediatric_Order_Sheet.pdf");
    });

    loadExcel();
  </script>
</body>
</html>
